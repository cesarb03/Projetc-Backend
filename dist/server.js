(()=>{"use strict";var t={740:(t,e,r)=>{r.r(e),r.d(e,{default:()=>a});const o=require("mongoose");var n=r.n(o),i=r(142);r.n(i)().config();const d={mongoDB:{URI:`mongodb+srv://${process.env.DB_USER}:${process.env.DB_PASSWORD}@${process.env.DB_CLUSTER}.mongodb.net/${process.env.DB_NAME}?retryWrites=true&w=majority`}};const s=new(n().Schema)({name:{type:String,required:!0,minlength:3,maxlength:70},price:{type:Number,required:!0,min:0},description:{type:String,required:!0,minlength:6,maxlength:200},photoURL:{type:String,required:!0,minlength:8,maxlength:200},stock:{type:Number,required:!0,min:0},timestamp:{type:Number,required:!0,default:Date.now}}),c=n().model("products",s);var u=function(t,e,r,o){return new(r||(r=Promise))((function(n,i){function d(t){try{c(o.next(t))}catch(t){i(t)}}function s(t){try{c(o.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((o=o.apply(t,e||[])).next())}))};const a=new class extends class{constructor(t){this.model=t,this.connect()}connect(){return t=this,e=void 0,o=function*(){try{yield n().connect(d.mongoDB.URI),console.log("connected to mongoDB Atlas")}catch(t){console.log(t)}},new((r=void 0)||(r=Promise))((function(n,i){function d(t){try{c(o.next(t))}catch(t){i(t)}}function s(t){try{c(o.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((o=o.apply(t,e||[])).next())}));var t,e,r,o}}{constructor(){super(c)}getAll(){return u(this,void 0,void 0,(function*(){try{return yield this.model.find({})}catch(t){console.log(t)}}))}getById(t){return u(this,void 0,void 0,(function*(){try{const e=yield this.model.findOne({_id:t},{__v:0});return null===e?{error:"Product not found"}:e}catch(t){console.log("Method getById: ",t)}}))}addProduct(t){return u(this,void 0,void 0,(function*(){try{const e=new this.model(t);return yield e.save()}catch(t){console.log(t)}}))}updateProduct(t,e){return u(this,void 0,void 0,(function*(){try{return 0===(yield this.model.updateOne({_id:t},e)).matchedCount?{error:"Product not found."}:{msg:`Product ${t} updated!`}}catch(t){console.log("Method update: ",t)}}))}deleteProduct(t){return u(this,void 0,void 0,(function*(){try{return 0===(yield this.model.deleteOne({_id:t})).deletedCount?{error:"Product not found."}:{msg:"Product deleted."}}catch(t){console.log("Method deleteById: ",t)}}))}}},142:t=>{t.exports=require("dotenv")}},e={};function r(o){var n=e[o];if(void 0!==n)return n.exports;var i=e[o]={exports:{}};return t[o](i,i.exports,r),i.exports}r.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return r.d(e,{a:e}),e},r.d=(t,e)=>{for(var o in e)r.o(e,o)&&!r.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{const t=require("express");var e=r.n(t);let o;"mongodb"===process.env.DB_PROVIDER?Promise.resolve().then(r.bind(r,740)).then((t=>o=t.default)):o=r(740);var n=function(t,e,r,o){return new(r||(r=Promise))((function(n,i){function d(t){try{c(o.next(t))}catch(t){i(t)}}function s(t){try{c(o.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((o=o.apply(t,e||[])).next())}))};const i=require("fs");var d=r.n(i),s=function(t,e,r,o){return new(r||(r=Promise))((function(n,i){function d(t){try{c(o.next(t))}catch(t){i(t)}}function s(t){try{c(o.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((o=o.apply(t,e||[])).next())}))};class c{constructor(t){this.writeFile=t=>s(this,void 0,void 0,(function*(){try{yield d().promises.writeFile(c.fileName,JSON.stringify(t,null,2))}catch(t){console.log("Method: writeFile, ",t)}})),this.readCartFile=()=>s(this,void 0,void 0,(function*(){try{return(yield d().promises.readFile(c.fileName,"utf8"))?JSON.parse(yield d().promises.readFile(c.fileName,"utf8")):[]}catch(t){if(-2===t.errno)try{return yield d().promises.writeFile(c.fileName,JSON.stringify([])),[]}catch(t){console.error("Method: readFile: could not create file in such directory.",t)}else console.log("Method readFile: ",t);return[]}})),this.readProductsFile=()=>s(this,void 0,void 0,(function*(){try{return(yield d().promises.readFile(this.productFilePath,"utf8"))?JSON.parse(yield d().promises.readFile(this.productFilePath,"utf8")):[]}catch(t){if(-2===t.errno)try{return yield d().promises.writeFile(this.productFilePath,JSON.stringify([])),[]}catch(t){console.error("Could not create file in such directory. ",t)}else console.log("Method readFile: ",t);return[]}})),this.createNewCart=()=>s(this,void 0,void 0,(function*(){try{const t=yield this.readCartFile(),e=(new Date).toLocaleString("es-AR");if(0===t.length||void 0===t)return yield this.writeFile([{cartId:1,timestamp:e,products:[]}]),1;{const r=Math.max(...t.map((t=>t.cartId)))+1;return yield this.writeFile([...t,{cartId:r,timestamp:e,products:[]}]),r}}catch(t){return console.error(t),t}})),this.cartDeleteById=t=>s(this,void 0,void 0,(function*(){try{const e=yield this.readCartFile();if(0===e.length||void 0===e)return-1;{const r=e.filter((e=>e.cartId!==t));return r.length===e.length?-2:(yield this.writeFile(r),200)}}catch(t){return console.error(t),t}})),this.getProductsByCartId=t=>s(this,void 0,void 0,(function*(){try{const e=(yield this.readCartFile()).find((e=>e.cartId===t));if(void 0!==e){const t=e.products;return 0===t.length?new Error("Cart has no products."):t}return new Error("Cart not found")}catch(t){return console.error(t),t}})),this.addToCartById=(t,e)=>s(this,void 0,void 0,(function*(){try{const r=Number(e.id),o=yield this.readCartFile(),n=o.find((e=>e.cartId===t)),i=(yield this.readProductsFile()).filter((t=>{if(t.id===r)return t}));if(0===i.length)return new Error(`There is no such product with id= ${r}`);if(void 0!==n&&void 0!==i){const e=[...n.products,...i],r=o.map((r=>r.cartId===t?Object.assign(Object.assign({},r),{products:e}):r));return yield this.writeFile(r),i}}catch(t){return console.error(t),t}})),this.deleteProductByCartId=(t,e)=>s(this,void 0,void 0,(function*(){try{const r=yield this.readCartFile(),o=r.find((e=>e.cartId===t));if(void 0===o)return new Error(`Cart id=${t} not found.`);{const n=o.products.filter((t=>t.id!==e));if(n.length===o.products.length)return new Error(`Product id=${e} not found in cart id=${t}.`);{const e=r.map((e=>e.cartId===t?Object.assign(Object.assign({},e),{products:n}):e));yield this.writeFile(e)}}}catch(t){return console.error(t),t}})),c.fileName=t,this.productFilePath="./src/db/products.txt",d().existsSync(`./${c.fileName}`)||d().promises.writeFile(`./${c.fileName}`,"").then((()=>console.log(`${c.fileName} created`)))}}const u=new c("./src/data/cart.txt");var a=function(t,e,r,o){return new(r||(r=Promise))((function(n,i){function d(t){try{c(o.next(t))}catch(t){i(t)}}function s(t){try{c(o.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((o=o.apply(t,e||[])).next())}))};const l=(t,e,r)=>{r()},f=(0,t.Router)();f.get("/products",((t,e)=>n(void 0,void 0,void 0,(function*(){const t=yield o.getAll();e.json(t)})))),f.get("/products/:id",((t,e)=>n(void 0,void 0,void 0,(function*(){const{id:r}=t.params,n=yield o.getById(Number(r));e.json(n)})))),f.post("/products",l,((t,e)=>n(void 0,void 0,void 0,(function*(){const r=t.body,n=yield o.addProduct(r);e.json(n)})))),f.put("/products/:id",l,((t,e)=>n(void 0,void 0,void 0,(function*(){const{id:r}=t.params,n=t.body;yield o.updateProductById(Number(r),n),e.json({msg:`Product ${r} updated.`})})))),f.delete("/products/:id",l,((t,e)=>n(void 0,void 0,void 0,(function*(){const{id:r}=t.params,n=yield o.deleteProductById(Number(r));e.json({deletedProduct:n})})))),f.post("/cart",((t,e)=>a(void 0,void 0,void 0,(function*(){const t=yield u.createNewCart();if("number"!=typeof t)return e.status(500).json({error:-1,msg:"Error creating cart",cartId:t});e.json(t)})))),f.delete("/cart/:id",((t,e)=>a(void 0,void 0,void 0,(function*(){const{id:r}=t.params,o=yield u.cartDeleteById(Number(r));return o instanceof Error?e.status(500).json({error:-1,msg:o.message}):-1===o?e.status(500).json({error:-1,msg:"Cart file is empty!"}):-2===o?e.status(500).json({error:-2,msg:`There is no cart with id= ${r}`}):void e.json(`Cart id: ${r} deleted.`)})))),f.get("/cart/:id/products",((t,e)=>a(void 0,void 0,void 0,(function*(){const{id:r}=t.params,o=yield u.getProductsByCartId(Number(r));if(o instanceof Error)return e.status(500).json({error:-1,msg:o.message});e.json(o)})))),f.post("/cart/:id/products",((t,e)=>a(void 0,void 0,void 0,(function*(){const{id:r}=t.params,o=t.body,n=yield u.addToCartById(Number(r),o);if(n instanceof Error)return e.status(500).json({error:-1,msg:n.message});e.json(n)})))),f.delete("/cart/:id/products/:id_prod",((t,e)=>a(void 0,void 0,void 0,(function*(){const{id:r,id_prod:o}=t.params,n=yield u.deleteProductByCartId(Number(r),Number(o));if(n instanceof Error)return e.status(500).json({error:-1,msg:n.message});e.json(n)}))));const h=f;var v=r(142);r.n(v)().config();const y=process.env.PORT,p=e()();p.use(e().json()),p.use(e().urlencoded({extended:!0})),p.use("/api",h),p.use(((t,e,r)=>{if(!t.originalUrl.includes("/api/cart")||!t.originalUrl.includes("/api/products"))return e.status(401).json({error:-2,msg:`${t.method}: ${t.originalUrl} --\x3e Not implemented`});r()})),p.listen(y,(()=>{console.log(`Server listening on port: ${y}`)}))})()})();